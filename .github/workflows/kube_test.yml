name: Kube and Test

on:
  workflow_run:
    workflows: ["Scan"]
    types: [completed]
  workflow_dispatch:

jobs:
  test-k3s:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get lowercase URI
        id: get_lowercase_uri
        run: |
          URI="ghcr.io/${{ github.repository }}" # Get the repository value
          LOWERCASE_URI=$(echo "$URI" | awk '{print tolower($0)}') # Convert to lowercase
          echo "lowercase_uri=$LOWERCASE_URI" >> $GITHUB_OUTPUT

      # Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
          registry: ghcr.io

      # Install k3d (K3s in Docker)
      - name: Install k3d
        run: |
          docker system prune -af
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      # Create k3d cluster using local registry
      - name: Create k3d cluster
        run: |
          # Create cluster + managed registry
          k3d cluster create github-ci \
            --agents 1 \
            --registry-create k3d-registry:5000 \
            --wait

      # Load docker image into k3s/k3d
      - name: Load Docker image
        run: |
          docker pull ${{ steps.get_lowercase_uri.outputs.lowercase_uri }}/fastapi-app:latest

      # Tag image for local registry
      - name: Tag image for local registry
        run: docker tag ${{ steps.get_lowercase_uri.outputs.lowercase_uri }}/fastapi-app:latest localhost:5000/fastapi-app:latest

      # Push image to local registry
      - name: Push image to local registry
        run: |
          docker push localhost:5000/fastapi-app:latest
          docker ps

      # Deploy Kubernetes manifests using local registry image
      - name: Deploy application
        run: |
          sed -i 's|IMAGE_PLACEHOLDER|localhost:5000/fastapi-app:latest|g' deployment.yaml
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          cat deploment.yaml

      # Wait for pod readiness
      - name: Wait for pod readiness
        run: | 
          kubectl get pods -l app=gpt-hf-pod -o wide
          kubectl describe pod -l app=gpt-hf-pod
          kubectl logs -l app=gpt-hf-pod
          kubectl wait --for=condition=ready pod -l app=gpt-hf-pod --timeout=600s || kubectl describe pod -l app=gpt-hf-pod

      # Debug: show pods and services
      - name: Show pods and services
        run: |
          kubectl get nodes -o wide
          kubectl get pods -o wide
          kubectl get svc -o wide

      # Test API inside cluster (internal pod)
      - name: Test API inside cluster
        run: |
          kubectl run curl-test --rm -i --tty --restart=Never \
            --image=curlimages/curl \
            -- curl -s -X POST http://gpt-hf-service:8000/chat \
              -H "Content-Type: application/json" \
              -d '{"question":"What does Hugging Face provide?","context":"Hugging Face is a technology company..."}'

      # Install Krew + kube-score
      - name: Install Krew and kube-score
        run: |
          set -e
          (
            cd "$(mktemp -d)" &&
            OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
            ARCH="$(uname -m | sed 's/x86_64/amd64/' | sed 's/arm64/arm64/')" &&
            curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-${OS}_${ARCH}.tar.gz" &&
            tar zxvf krew-${OS}_${ARCH}.tar.gz &&
            ./krew-${OS}_${ARCH} install krew
          )
          export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
          kubectl krew install score
          kubectl score version

      # Run kube-score
      - name: Run kube-score
        run: |
          export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
          kubectl score score --output-format ci deployment.yaml || true

      # Cleanup cluster and registry
      - name: Cleanup k3d cluster and registry
        if: always()
        run: |
          k3d cluster delete github-ci || true
          docker rm -f k3d-registry || true

  failure-message:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Previous workflow failed
        run: |
          echo "Previous workflow failed" 
          exit 1
